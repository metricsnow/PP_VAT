# Bug Report: Incorrect Total Values in Document Analysis

## Bug Information
- **Bug ID**: BUG-002
- **Created**: 2025-01-28
- **Status**: ✅ Fixed and Deployed
- **Severity**: High
- **Priority**: High
- **Reporter**: User via Mission-QA Bugfix analysis

## Bug Description
The "DOCUMENT ANALYSIS" section displays incorrect total values that are approximately 10x larger than the actual invoice totals shown in the PDF documents. Additionally, the importer box width needs to be increased by 10px.

## Steps to Reproduce
1. Upload a PDF invoice (e.g., Swiss invoice with total 1.540,00)
2. Process the document
3. View the Document Analysis section
4. **Observe**: Prior total shows 13.975,39 instead of 1.540,00
5. **Observe**: Corrected total shows 12.928,23 instead of ~1.424,61
6. **Observe**: Importer box appears too narrow

## Expected Behavior
- Prior total value should match the "Total Value" in the PDF (e.g., 1.540,00)
- Corrected total value should be calculated from the actual total (e.g., 1.424,61)
- Importer box should have 10px more width on the right side

## Actual Behavior
- Prior total: 13.975,39 (incorrect - sum of all occurrences including duplicates)
- Corrected total: 12.928,23 (incorrect - calculated from wrong prior total)
- Importer box width: 280px (too narrow)

## Environment
- **Platform**: Both local and Google Cloud Run (Docker)
- **Version**: Production build
- **Issue affected**: All environments

## Root Cause Analysis

### Issue #1: Incorrect Total Calculation

**Problem:**
Lines 533-534 in `project/src/main.py`:
```python
prior_total = sum([price_info[3] for price_info in all_prices])
corrected_total = sum([price_info[4] for price_info in all_prices])
```

This code sums ALL prices found in the document, including:
- Duplicate occurrences of the same price (appearing in headers, line items, summaries, etc.)
- VAT amounts that should be excluded from the total
- Intermediate calculations and subtotals

**Evidence from logs:**
```
Found 10 prices to update
- 9 instances of 1540.0
- 1 instance of 115.39
Sum = 9 × 1540.0 + 115.39 = 13,975.39 ❌ (Should be 1,540.00)
```

**Why This Happens:**
The PDF extraction finds every occurrence of price-like patterns in the document:
- "Total Value: 1.540,00" appears once (the actual total)
- "1.540,00" appears multiple times in headers and line items
- "115,39" appears as the VAT amount
- All of these get summed together, inflating the total

### Issue #2: Importer Box Width

**Problem:**
Line 118 in `project/src/main.py`:
```python
box_width = 280  # Too narrow
```

The box was specified as 280px, but needs to be 10px wider to accommodate the content properly.

## Fix Implementation

### Solution #1: Extract Actual Total from PDF Text

**New Approach:**
Instead of summing all found prices, extract the actual "Total Value" from the document text using regex patterns:

```python
# Look for "Total Value:" or similar patterns in the text
total_patterns = [
    r'Total\s+Value[:\s]+(\d{1,3}(?:\.\d{3})*,\d{2})',
    r'Betrag[:\s]+(\d{1,3}(?:\.\d{3})*,\d{2})',
    r'Gesamt[:\s]+(\d{1,3}(?:\.\d{3})*,\d{2})'
]

for pattern in total_patterns:
    match = re.search(pattern, full_text, re.IGNORECASE)
    if match:
        prior_total = float(total_str.replace('.', '').replace(',', '.'))
        break
```

**Fallback:**
If the "Total Value" pattern is not found, use the maximum unique price:
```python
unique_original_values = set([price_info[3] for price_info in all_prices])
prior_total = max(unique_original_values)
```

**Corrected Total Calculation:**
```python
# Remove VAT from prior total
corrected_total = prior_total / (1 + detected_vat / 100)
```

### Solution #2: Increase Box Width

**Change:**
```python
box_width = 290  # Increased from 280 by 10px on right side
```

## Impact Assessment

### Business Impact
- **High**: Incorrect totals shown to users undermine trust in the application
- **User Experience**: Confusing discrepancy between displayed totals and PDF values
- **Compliance**: May lead to incorrect VAT calculations being submitted

### Technical Impact
- **Medium**: Logic error in aggregation algorithm
- **Medium**: Simple configuration change for box width
- **Low**: No breaking changes to existing functionality

## Testing Strategy

### Test Case 1: Swiss Invoice (1.540,00 total)
- **Expected**: Prior total = 1.540,00
- **Expected**: Corrected total = 1.424,61 (with 8.1% VAT)
- **Verify**: Values match the PDF totals exactly

### Test Case 2: Multi-page Invoice
- **Expected**: Total extracted from summary page
- **Verify**: Only counts final total, not all line items

### Test Case 3: Importer Box
- **Expected**: Box width = 290px
- **Verify**: Text fits comfortably without overflow

## Deployment Record

### Deployment History
**First attempt:** 2025-10-28 at 16:00 UTC (revision pp-vat-00007-sgk) - Initial fix  
**Second deployment:** 2025-10-28 at 17:15 UTC (revision pp-vat-00008-mxl) - Lookbehind error  
**Final deployment:** 2025-10-28 at 17:30 UTC (revision pp-vat-00009-kb6) - All fixes applied

### Deployment Details
- **Service**: pp-vat
- **Region**: europe-west8 (Milan, Italy)
- **Project**: ppdev-476508
- **Revision**: pp-vat-00009-kb6 (includes all fixes)
- **Status**: ✅ Deployed successfully
- **Service URL**: https://pp-vat-613290506191.europe-west8.run.app

### Deployment Command
```bash
gcloud run deploy pp-vat --source . --region europe-west8 --allow-unauthenticated
```

### Post-Deployment Verification
- [x] Service is running
- [x] Health endpoint responding
- [x] New revision deployed
- [ ] Totals display correctly (pending user verification)
- [ ] Importer box width increased (pending user verification)

## Success Criteria
- [x] Total calculation uses PDF text extraction instead of sum
- [x] SUM-Net-Value pattern prioritized as primary extraction method
- [x] Fixed-width lookbehind pattern to avoid regex errors
- [x] Fallback to max unique price if pattern not found
- [x] Yellow highlight boxes extended by 10px on right side (padding_right = 12)
- [x] Importer box width increased from 280px to 290px
- [x] Regex error fixed (no lookbehind variable-width patterns)
- [x] Code committed to repository (commits: 42d3307, fbd2438, fbc168e)
- [x] Deployed to production (revision pp-vat-00009-kb6)
- [ ] User verification of correct totals in Document Analysis
- [ ] User verification of extended yellow highlight boxes
- [ ] User verification of increased importer box width

## Lessons Learned

### Why This Happened
1. The initial implementation summed all found prices without considering duplicates
2. No validation that totals matched the PDF's actual total
3. Box width was hardcoded without testing with actual content

### Prevention
1. Always validate calculated totals against extracted totals from PDF text
2. Use pattern matching to find specific summary fields rather than aggregating all occurrences
3. Test UI components with real content to determine appropriate sizing

### Code Review Checklist
- [ ] Verify calculated totals match source documents
- [ ] Test with various invoice formats
- [ ] Validate UI sizing with actual content
- [ ] Check for duplicate counting in aggregations

## Additional Issues Fixed

### Issue #3: Regex Lookbehind Error
**Error Message**: `"look-behind requires fixed-width pattern"`

**Root Cause:**
Variable-width lookbehind patterns were used:
- ❌ `(?<!VAT[:\s])` - contains character class `[:\s]` (variable width)
- ❌ `(?<!\%\s*VAT[:\s])` - contains `\s*` quantifier (variable width)

Python's `re` module requires fixed-width patterns in lookbehind assertions.

**Fix:**
1. Removed variable-width lookbehind patterns
2. Priorized `SUM-Net-Value` pattern (most specific and reliable)
3. Used fixed-width lookbehind for "Total Value": `(?<!VAT)` (exactly 3 characters)
4. Ordered patterns by specificity to avoid false matches

**Pattern Order (final):**
1. `SUM-Net-Value[:\s]+(\d{1,3}(?:\.\d{3})*,\d{2})` - Most specific, extracts net total
2. `(?<!VAT)Total\s+Value[:\s]+(\d{1,3}(?:\.\d{3})*,\d{2})` - Avoids "VAT Total Value"
3. `Betrag[:\s]+(\d{1,3}(?:\.\d{3})*,\d{2})` - German "Betrag" (amount)
4. `Gesamt[:\s]+(\d{1,3}(?:\.\d{3})*,\d{2})` - German "Gesamt" (total)

---

**Status**: ✅ All Fixes Applied and Deployed  
**Next Step**: User verification of all fixes in production environment  
**Latest Revision**: pp-vat-00009-kb6
